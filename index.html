<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
    <title>ChatKit na Netlify</title>
    <style>
      body { margin: 0; font-family: system-ui, sans-serif; background: #f6f7fb; color: #0f172a; }
      .layout { display: grid; grid-template-columns: 220px 1fr; min-height: 100vh; }
      .sidebar { background: #111827; color: #fff; padding: 18px; }
      .sidebar a, .sidebar button { display:block; width:100%; text-align:left; margin:6px 0; padding:9px 10px; border-radius:8px; border:0; background:transparent; color:inherit; text-decoration:none; cursor:pointer; }
      .sidebar a.active { background: #2563eb; }
      .content { padding: 24px; }
      .card { background:#fff; border-radius:12px; padding:20px; box-shadow: 0 10px 20px rgba(0,0,0,.06); max-width:520px; }
      input, button, select { font: inherit; }
      input { width:100%; padding:10px; margin-top:6px; margin-bottom:10px; border:1px solid #cbd5e1; border-radius:8px; box-sizing:border-box; }
      button.primary { background:#1d4ed8; color:white; border:0; border-radius:8px; padding:10px 12px; cursor:pointer; }
      .muted { color:#64748b; }
      #chat-wrap { height: calc(100vh - 48px); }
      openai-chatkit { display:block; height:100%; }
      .row { display:flex; gap:10px; flex-wrap: wrap; }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script>
      let me = null;
      let chatMounted = false;

      const protectedRoutes = new Set(['/chat', '/evaluator-nis2', '/calendly']);

      async function api(path, options = {}) {
        const res = await fetch(`/.netlify/functions/${path}`, {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
          ...options,
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Request failed');
        return data;
      }

      function navigate(path) { history.pushState({}, '', path); render(); }
      window.addEventListener('popstate', render);

      async function loadMe() {
        try { const data = await api('me', { method: 'GET' }); me = data.user; }
        catch { me = null; }
      }

      function accessOk() {
        return Boolean(me?.has_access);
      }

      function shell(content) {
        if (!me) return `<main class='content'>${content}</main>`;
        const links = [
          ['/chat','Chat'], ['/evaluator-nis2','Evaluator NIS2'], ['/calendly','Calendly'], ['/pricing','Pricing'], ['/account','Account']
        ];
        return `<div class='layout'><aside class='sidebar'><h3>Menu</h3>${links.map(([href,label])=>`<a href='${href}' data-link class='${location.pathname===href?'active':''}'>${label}</a>`).join('')}<button id='logout'>Wyloguj</button></aside><main class='content'>${content}</main></div>`;
      }

      async function mountChat() {
        if (chatMounted) return;
        await customElements.whenDefined('openai-chatkit');
        const chatkit = document.getElementById('my-chat');
        const userId = `user_${me.id}`;
        chatkit.setOptions({
          api: {
            async getClientSecret(currentClientSecret) {
              const data = await api('chatkit-session', { method: 'POST', body: JSON.stringify({ user: userId, currentClientSecret }) });
              return data.client_secret;
            }
          },
          theme: { colorScheme: 'light', radius: 'pill', density: 'compact' },
          composer: { attachments: { enabled: true, maxCount: 5, maxSize: 10485760 } },
          startScreen: { greeting: '', prompts: [{ icon:'circle-question', label:'Czy moja firma podlega pod NIS2 i jak to sprawdzić?', prompt:'Czy moja firma podlega pod NIS2 i jak to sprawdzić?' }] }
        });
        chatMounted = true;
      }

      function bindGlobalHandlers() {
        document.querySelectorAll('[data-link]').forEach((el)=>el.addEventListener('click',(e)=>{e.preventDefault(); navigate(el.getAttribute('href'));}));
        const logout = document.getElementById('logout');
        if (logout) logout.onclick = async () => { await api('logout', { method: 'POST' }); me = null; navigate('/login'); };

        const loginForm = document.getElementById('login-form');
        if (loginForm) loginForm.onsubmit = async (e) => {
          e.preventDefault();
          const email = loginForm.email.value; const password = loginForm.password.value;
          try { await api('login', { method: 'POST', body: JSON.stringify({ email, password }) }); await loadMe(); navigate('/chat'); }
          catch (err) { document.getElementById('form-error').textContent = err.message; }
        };

        const registerForm = document.getElementById('register-form');
        if (registerForm) registerForm.onsubmit = async (e) => {
          e.preventDefault();
          const email = registerForm.email.value; const password = registerForm.password.value;
          try { await api('register', { method: 'POST', body: JSON.stringify({ email, password }) }); await loadMe(); navigate('/chat'); }
          catch (err) { document.getElementById('form-error').textContent = err.message; }
        };

        document.querySelectorAll('[data-plan]').forEach((btn) => btn.onclick = async () => {
          const plan = btn.getAttribute('data-plan');
          try {
            const data = await api('billing-checkout', { method: 'POST', body: JSON.stringify({ plan }) });
            location.href = data.url;
          } catch (err) { alert(err.message); }
        });
      }

      async function render() {
        await loadMe();
        const path = location.pathname;
        if (protectedRoutes.has(path) && !me) return navigate('/login');
        if (protectedRoutes.has(path) && me && !accessOk()) return navigate('/pricing?reason=no_access');

        let content = '';
        if (path === '/login') {
          content = `<div class='card'><h1>Logowanie</h1><form id='login-form'><label>Email</label><input name='email' type='email' required/><label>Hasło</label><input name='password' type='password' required/><button class='primary'>Zaloguj</button><p id='form-error' style='color:#b91c1c'></p><p class='muted'>Nie masz konta? <a href='/register' data-link>Zarejestruj się</a></p></form></div>`;
        } else if (path === '/register') {
          content = `<div class='card'><h1>Rejestracja</h1><form id='register-form'><label>Email</label><input name='email' type='email' required/><label>Hasło</label><input name='password' type='password' minlength='8' required/><button class='primary'>Utwórz konto</button><p id='form-error' style='color:#b91c1c'></p></form><p class='muted'>Po rejestracji dostajesz trial 24h.</p></div>`;
        } else if (path === '/chat') {
          content = `<h1>Chat</h1><div id='chat-wrap'><openai-chatkit id='my-chat'></openai-chatkit></div>`;
        } else if (path === '/evaluator-nis2') {
          content = `<div class='card'><h1>Evaluator NIS2</h1><p>Wkrótce.</p></div>`;
        } else if (path === '/calendly') {
          content = `<div class='card'><h1>Calendly</h1><p>Wkrótce.</p></div>`;
        } else if (path === '/pricing') {
          const reason = new URLSearchParams(location.search).get('reason');
          content = `<div class='card'><h1>Cennik</h1>${reason==='no_access' ? "<p style='color:#b91c1c'>Brak aktywnego dostępu. Wybierz plan.</p>" : ''}<p>Trial 1 dzień po rejestracji.</p><div class='row'><button class='primary' data-plan='weekly'>Kup tygodniowy (199 PLN)</button><button class='primary' data-plan='monthly'>Kup miesięczny (499 PLN)</button></div></div>`;
        } else if (path === '/account') {
          if (!me) return navigate('/login');
          content = `<div class='card'><h1>Account</h1><p><b>Email:</b> ${me.email}</p><p><b>Trial:</b> do ${me.trial_expires_at || '-'}</p><p><b>Plan:</b> ${me.plan || 'brak'}</p><p><b>Status subskrypcji:</b> ${me.subscription_status || 'brak'}</p><p><b>Dostęp aktywny:</b> ${me.has_access ? 'tak' : 'nie'}</p><div class='row'><button class='primary' data-plan='weekly'>Kup tygodniowy</button><button class='primary' data-plan='monthly'>Kup miesięczny</button></div></div>`;
        } else if (path === '/billing/success') {
          content = `<div class='card'><h1>Płatność zakończona</h1><p>Dziękujemy. Dostęp zostanie aktywowany po webhooku Stripe.</p><a href='/account' data-link>Przejdź do konta</a></div>`;
        } else if (path === '/billing/cancel') {
          content = `<div class='card'><h1>Płatność anulowana</h1><a href='/pricing' data-link>Wróć do cennika</a></div>`;
        } else {
          return navigate(me ? '/chat' : '/login');
        }

        document.getElementById('app').innerHTML = shell(content);
        bindGlobalHandlers();
        if (path === '/chat' && me) mountChat();
      }

      render();
    </script>
  </body>
</html>
